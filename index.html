<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Wm Discador</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
/* === CSS ORIGINAL (NÃO ALTERADO) === */
body{font-family:Poppins,sans-serif;background:#f4f6f9;margin:0}
header{display:flex;align-items:center;justify-content:space-between;padding:16px 32px;background:#fff;border-bottom:1px solid #ddd}
h1{color:#003366}
#top-bar{display:flex;gap:10px;flex-wrap:wrap;padding:16px 32px;background:#fafafa;border-bottom:1px solid #ddd}
button{padding:8px 14px;border:none;border-radius:6px;font-weight:600;cursor:pointer}
.btn-whats{background:#25D366;color:#fff}
.btn-reset{background:#6c757d;color:#fff}
.btn-backup{background:#007bff;color:#fff}
.contato-card{background:#fff;margin:16px 32px;padding:14px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,.08)}
footer{position:fixed;bottom:0;width:100%;background:#003366;color:#fff;text-align:center;padding:10px}
</style>
</head>

<body>

<header>
  <h1>Wm Discador</h1>
  <button class="btn-reset" onclick="resetGeral()">Reset Geral</button>
</header>

<div id="top-bar">
  <input type="file" id="fileInput" accept=".csv,.txt">
  <textarea id="pasteInput" rows="2" placeholder="Nome, Número"></textarea>
  <button onclick="importarColado()">Importar colados</button>
  <button class="btn-backup" onclick="exportarCSV()">Backup</button>
</div>

<p id="contador" style="padding:0 32px;font-weight:600">Contatos feitos hoje: 0</p>

<div id="lista-contatos"></div>

<footer>WM Discador</footer>

<script>
/* ================= BASE ================= */
let contatos = JSON.parse(localStorage.getItem("wm_contatos")) || [];
let feitos = JSON.parse(localStorage.getItem("wm_feitos")) || [];
let estadoLeads = JSON.parse(localStorage.getItem("wm_estado_leads")) || {};

function salvar(){
  localStorage.setItem("wm_contatos", JSON.stringify(contatos));
  localStorage.setItem("wm_feitos", JSON.stringify(feitos));
  localStorage.setItem("wm_estado_leads", JSON.stringify(estadoLeads));
}

/* ================= UTIL ================= */
function formatarNomeParaEnvio(nome){
  return nome.toLowerCase().split(/\s+/)
    .map(p=>p.charAt(0).toUpperCase()+p.slice(1))
    .join(" ");
}

function saudacaoPorHorario(){
  const h=new Date().getHours();
  if(h<12) return "Bom dia";
  if(h<18) return "Boa tarde";
  return "Boa noite";
}

/* ================= MENSAGENS ================= */
/* COLE AQUI O CONTEÚDO DO messages.json */
const BANCO_MENSAGENS = [
  "Sou William e trabalho ajudando pessoas que demonstraram interesse em comprar um imóvel, mas ainda estão avaliando o melhor momento.\n\nCostumo começar com algumas perguntas simples para entender o perfil e orientar melhor os próximos passos.\n\nPodemos conversar rapidamente?"
];

/* ================= GERAR MENSAGEM ================= */
function gerarMensagem(nomeOriginal, numero){
  if(!estadoLeads[numero]){
    estadoLeads[numero] = {
      indice: Math.floor(Math.random()*BANCO_MENSAGENS.length)
    };
  }

  let msg = BANCO_MENSAGENS[estadoLeads[numero].indice];
  const nome = formatarNomeParaEnvio(nomeOriginal);

  msg = `${saudacaoPorHorario()} ${nome},\n\n${msg}`;

  salvar();
  return msg;
}

/* ================= UPLOAD CSV/TXT (FIX GITHUB PAGES) ================= */
document.getElementById("fileInput").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;

  const nome = file.name.toLowerCase();

  if(!nome.endsWith(".csv") && !nome.endsWith(".txt")){
    alert("Formato inválido. Use CSV ou TXT.");
    return;
  }

  const reader = new FileReader();
  reader.onload = ev=>{
    ev.target.result.split(/\r?\n/).forEach(l=>{
      const [n,t]=l.split(/,|;/);
      if(n&&t){
        contatos.push({nome:n.trim(),numero:t.trim()});
      }
    });
    salvar();
    render();
  };
  reader.readAsText(file);
});

/* ================= COLAR LEADS ================= */
function importarColado(){
  const texto = document.getElementById("pasteInput").value.trim();
  if(!texto) return;

  texto.split(/\r?\n/).forEach(l=>{
    const [n,t]=l.split(/,|;/);
    if(n&&t){
      contatos.push({nome:n.trim(),numero:t.trim()});
    }
  });

  document.getElementById("pasteInput").value="";
  salvar();
  render();
}

/* ================= WHATSAPP ================= */
function enviarWhats(i){
  const c=contatos[i];
  const num=c.numero.replace(/\D/g,"");
  const msg=gerarMensagem(c.nome,num);

  window.open("https://wa.me/55"+num+"?text="+encodeURIComponent(msg));
  feitos.push({data:new Date().toLocaleDateString()});
  contatos.splice(i,1);
  salvar();
  render();
}

/* ================= RENDER ================= */
function render(){
  const lista=document.getElementById("lista-contatos");
  lista.innerHTML="";

  contatos.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className="contato-card";
    d.innerHTML=`<b>${c.nome}</b> - ${c.numero}
      <button class="btn-whats" onclick="enviarWhats(${i})">Whats</button>`;
    lista.appendChild(d);
  });

  atualizarContador();
}

function atualizarContador(){
  const hoje=new Date().toLocaleDateString();
  const total=feitos.filter(f=>f.data===hoje).length;
  document.getElementById("contador").innerText="Contatos feitos hoje: "+total;
}

/* ================= OUTROS ================= */
function exportarCSV(){
  const csv="Nome,Número\n"+contatos.map(c=>`${c.nome},${c.numero}`).join("\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="leads.csv";
  a.click();
}

function resetGeral(){
  if(confirm("Apagar tudo?")){
    contatos=[];feitos=[];estadoLeads={};
    localStorage.clear();
    render();
  }
}

render();
</script>
</body>
</html>
