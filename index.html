<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wm Discador</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:'Poppins',sans-serif;
    background:#f4f6f9;
    color:#333;
    padding-bottom:80px;
  }
  header{
    display:flex;align-items:center;justify-content:space-between;
    padding:16px 32px;background:#fff;border-bottom:2px solid #e5e7eb;
  }
  .logo-box{display:flex;align-items:center;gap:16px}
  .logo-box img{height:60px}
  header h1{font-size:26px;color:#003366;font-weight:600}
  #top-bar{
    display:flex;flex-wrap:wrap;align-items:center;gap:12px;
    padding:16px 32px;background:#fafafa;border-bottom:1px solid #ddd;
  }
  button{
    display:inline-flex;align-items:center;gap:6px;
    padding:10px 18px;border:none;border-radius:8px;font-weight:600;
    font-size:14px;cursor:pointer;transition:.25s;white-space:nowrap;
  }
  button:hover{opacity:.9;transform:translateY(-2px)}
  .btn-ligar{background:#dc3545;color:#fff}
  .btn-whats{background:#25D366;color:#fff}
  .btn-salvar{background:#ff9800;color:#fff}
  .btn-backup{background:#007bff;color:#fff}
  .btn-reset{background:#6c757d;color:#fff}
  .btn-acoes{background:#f1f3f5;color:#333}
  input[type="text"],select,textarea{
    padding:9px 12px;border:1px solid #ccc;border-radius:8px;font-size:14px
  }
  textarea{resize:vertical}
  #contador{padding:16px 32px;font-weight:600;color:#444}
  .contato-card{
    background:#fff;margin:16px 32px;border-radius:10px;
    box-shadow:0 1px 4px rgba(0,0,0,.08);padding:18px 22px
  }
  .contato-top{
    display:flex;flex-wrap:wrap;align-items:center;gap:12px;margin-bottom:10px
  }
  .contato-top span.nome{font-weight:600;min-width:230px}
  .contato-top span.numero{color:#555}
  .formulario{margin-top:10px;display:grid;gap:8px}
  .formulario select,.formulario textarea{border:1px solid #ccc;border-radius:8px;font-size:14px;padding:8px}
  h2.section{margin:32px 32px 8px;font-size:22px;color:#003366}
  table{width:calc(100% - 64px);margin:0 32px 32px;border-collapse:collapse}
  thead{background:#003366;color:#fff}
  th,td{padding:10px;border:1px solid #d1d5db;font-size:14px;text-align:left}
  tbody tr:nth-child(even){background:#f9fafb}
  footer{
    position:fixed;bottom:0;width:100%;padding:14px;
    background:#003366;color:#fff;text-align:center;font-size:13px
  }
  </style>
</head>
<body>

<header>
  <div class="logo-box">
    <img src="logo.png" alt="WM Logo">
    <h1>Wm Discador</h1>
  </div>
  <button class="btn-reset" onclick="resetGeral()">üîÑ Reset Geral</button>
</header>

<div id="top-bar">
  <!-- Upload de arquivos -->
  <input type="file" id="fileInput" accept=".csv,.txt,.pdf,.xlsx,.xls">

  <!-- Colagem de contatos -->
  <textarea id="pasteInput" placeholder="üìã Cole aqui a lista de contatos (Nome, N√∫mero)" rows="3" style="width:280px;"></textarea>
  <button class="btn-acoes" onclick="importarColado()">üì• Importar colados</button>

  <!-- Filtros -->
  <input type="text" id="filtroNome" placeholder="üîç Filtrar nome">
  <select id="filtroLead">
    <option value="">Todos os leads</option>
    <option value="Quente">üî• Quente</option>
    <option value="Frio">‚ùÑÔ∏è Frio</option>
    <option value="Aguardando">‚è≥ Aguardando</option>
  </select>
  <button class="btn-acoes" onclick="limparFiltros()">üßπ Limpar Filtros</button>
  <button class="btn-backup" onclick="exportarCSV()">üíæ Backup</button>
</div>

<p id="contador">üìä Contatos feitos hoje: 0</p>

<div id="meta-box" style="margin:10px 32px 0 32px;background:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,.08);">
  <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
    <span style="font-weight:600;">üéØ Meta di√°ria: <span id="metaValor">50</span></span>
    <span style="color:#555;">Progresso: <span id="metaProgresso">0/50</span></span>
  </div>
  <div style="margin-top:8px;width:100%;height:14px;background:#e5e7eb;border-radius:8px;overflow:hidden;">
    <div id="progresso" style="height:100%;width:0%;background:#25D366;transition:width .2s;"></div>
  </div>
</div>

<div id="lista-contatos"></div>

<h2 class="section">üìú Hist√≥rico de Liga√ß√µes</h2>
<table id="contatos-feitos">
  <thead><tr><th>Nome</th><th>N√∫mero</th><th>Status</th><th>Informa√ß√µes</th><th>Lead</th><th>Data/Hora</th></tr></thead>
  <tbody></tbody>
</table>

<footer>¬© 2025 WM Assessoria ‚Äì Todos os direitos reservados.</footer>

<script>

let contatos = JSON.parse(localStorage.getItem("wm_leads")) || [];
let contatosFeitos=JSON.parse(localStorage.getItem("contatosFeitos"))||[];

const META_DIARIA = 50;
const LIMITE_DIARIO_POR_NUMERO = 2;
const TEMPO_SEM_RESPOSTA = 48 * 60 * 60 * 1000;

let controleResposta = JSON.parse(localStorage.getItem("controleResposta")) || [];

// Bancos de mensagens (deixe messages.json e messages_fases.json na mesma pasta do index)
let bancoMensagens = [];
let mensagensFases = null;

fetch("messages.json")
  .then(r => r.json())
  .then(d => { if (Array.isArray(d)) bancoMensagens = d; })
  .catch(() => { bancoMensagens = []; });

fetch("messages_fases.json")
  .then(r => r.json())
  .then(d => { mensagensFases = d; })
  .catch(() => { mensagensFases = null; });

document.getElementById("fileInput").addEventListener("change",importarArquivo);
document.getElementById("filtroNome").addEventListener("input",renderizarContatos);
document.getElementById("filtroLead").addEventListener("change",renderizarContatos);

// --- Importar CSV/TXT ---
function importarArquivo(e){
  const f=e.target.files[0];
  if(!f)return;
  const ext=f.name.split(".").pop().toLowerCase();
  if(ext==="csv"||ext==="txt"){lerTexto(f);}
  else{alert("Suporte a PDF/Excel pode ser adicionado com bibliotecas externas.");}
}

function lerTexto(f){
  const r=new FileReader();
  r.onload=ev=>{
    const linhas=ev.target.result.split(/\r?\n/).slice(1);
    contatos=linhas.map(l=>{
      const[nome,numero]=l.split(/,|;/);
      return{nome:nome?.trim(),numero:numero?.trim()};
    }).filter(c=>c.nome&&c.numero);
    renderizarContatos();atualizarContador();wmSalvarContatos();
  };
  r.readAsText(f);
}

// --- Importar contatos colados ---
function importarColado(){
  const texto=document.getElementById("pasteInput").value.trim();
  if(!texto)return alert("Cole ao menos um contato!");
  const linhas=texto.split(/\r?\n/);
  linhas.forEach(l=>{
    const partes=l.split(/,|;/);
    let nome,numero;
    if(partes.length>=2){nome=partes[0].trim();numero=partes[1].trim();}
    else{
      const match=l.match(/(.+?)\s(\d{8,15})/);
      if(match){nome=match[1].trim();numero=match[2].trim();}
    }
    if(nome&&numero){contatos.push({nome,numero});}
  });
  renderizarContatos();atualizarContador();wmSalvarContatos();
  document.getElementById("pasteInput").value="";
}


function hojeISO(){ return new Date().toISOString().slice(0,10); }


function wmSalvarContatos(){
  localStorage.setItem("wm_leads", JSON.stringify(contatos));
}
function wmFormatarNome(nome){
  if(!nome) return "";
  return nome.toLowerCase().trim().split(/\s+/).map(p=>p.charAt(0).toUpperCase()+p.slice(1)).join(" ");
}
function wmSaudacao(){
  const h = new Date().getHours();
  if(h < 12) return "bom dia";
  if(h < 18) return "boa tarde";
  return "boa noite";
}

// Cooldown global (2 min) para evitar banimento
const WM_COOLDOWN_MS = 2 * 60 * 1000;
function wmPodeEnviarGlobal(){
  const t = Number(localStorage.getItem("wm_last_send_ts") || "0");
  if(!t) return {ok:true};
  const d = Date.now() - t;
  if(d >= WM_COOLDOWN_MS) return {ok:true};
  return {ok:false, restante: Math.ceil((WM_COOLDOWN_MS - d)/1000)};
}
function wmRegistrarEnvioGlobal(){
  localStorage.setItem("wm_last_send_ts", String(Date.now()));
}

// Banco follow-up (mesma quantidade/√≠ndice do messages.json)
let bancoFollowup = [];
fetch("messages_followup.json")
  .then(r => r.json())
  .then(d => { if (Array.isArray(d)) bancoFollowup = d; })
  .catch(() => { bancoFollowup = []; });

function wmGetLeadState(numero){
  const n = String(numero).replace(/\D/g,"");
  try{
    return JSON.parse(localStorage.getItem("wm_state_" + n) || "null");
  }catch(e){ return null; }
}
function wmSetLeadState(numero, st){
  const n = String(numero).replace(/\D/g,"");
  localStorage.setItem("wm_state_" + n, JSON.stringify(st));
}
function wmMensagemInicial(nome, numero){
  if(!bancoMensagens || bancoMensagens.length === 0){
    return `Ol√°, ${wmFormatarNome(nome)} ${wmSaudacao()}`;
  }
  const i = Math.floor(Math.random() * bancoMensagens.length);
  wmSetLeadState(numero, { idx:i, enviadoEm: Date.now(), followEnviado:false });
  const base = String(bancoMensagens[i])
    .replaceAll("{{nome}}", wmFormatarNome(nome))
    .replaceAll("{{ nome }}", wmFormatarNome(nome));
  return `Ol√°, ${wmFormatarNome(nome)} ${wmSaudacao()}\n\n${base}`.trim();
}
function wmMensagemFollowup(nome, numero){
  const st = wmGetLeadState(numero) || { idx:0, enviadoEm: Date.now(), followEnviado:false };
  const idx = Number.isFinite(st.idx) ? st.idx : 0;
  const base = String((bancoFollowup[idx] || bancoFollowup[0] || ""))
    .replaceAll("{{nome}}", wmFormatarNome(nome))
    .replaceAll("{{ nome }}", wmFormatarNome(nome));
  wmSetLeadState(numero, { idx: idx, enviadoEm: st.enviadoEm, followEnviado:true });
  return `Ol√°, ${wmFormatarNome(nome)} ${wmSaudacao()}\n\n${base}`.trim();
}
function wmPodeFollowup(numero){
  const st = wmGetLeadState(numero);
  if(!st) return false;
  if(st.followEnviado) return false;
  return (Date.now() - Number(st.enviadoEm || 0)) >= TEMPO_SEM_RESPOSTA;
}


function getControleNumero(numero){
  const key = "limite_" + numero;
  const hoje = hojeISO();
  const salvo = JSON.parse(localStorage.getItem(key));
  if(!salvo || salvo.data !== hoje) return {data:hoje,count:0};
  return salvo;
}
function podeEnviar(numero){
  const ctrl = getControleNumero(numero);
  return ctrl.count < LIMITE_DIARIO_POR_NUMERO;
}
function registrarEnvio(numero){
  const key = "limite_" + numero;
  const ctrl = getControleNumero(numero);
  ctrl.count += 1;
  localStorage.setItem(key, JSON.stringify(ctrl));
}

function registrarPrimeiroContato(nome, numero){
  if(controleResposta.find(r=>r.numero===numero)) return;
  controleResposta.push({nome,numero,primeiraTentativa:Date.now(),respondido:false});
  localStorage.setItem("controleResposta", JSON.stringify(controleResposta));
}

function marcarRespondido(numero){
  const r = controleResposta.find(r=>r.numero===numero);
  if(r){
    r.respondido = true;
    localStorage.setItem("controleResposta", JSON.stringify(controleResposta));
  }
}

function moverSemRespostaParaHistorico(){
  const agora = Date.now();
  let mudou = false;
  controleResposta.forEach(r=>{
    if(!r.respondido && (agora - r.primeiraTentativa) >= TEMPO_SEM_RESPOSTA){
      contatosFeitos.push({
        nome: r.nome,
        numero: r.numero,
        status: "Sem resposta (48h)",
        info: "",
        lead: "Aguardando",
        dataHora: new Date(r.primeiraTentativa + TEMPO_SEM_RESPOSTA).toLocaleString()
      });
      r.respondido = true;
      mudou = true;
    }
  });
  if(mudou){
    localStorage.setItem("controleResposta", JSON.stringify(controleResposta));
    localStorage.setItem("contatosFeitos", JSON.stringify(contatosFeitos));
    atualizarContatosFeitos();
    atualizarContador();
  }
}

// Fases 1..3 por n√∫mero
function getFaseContato(numero){
  return parseInt(localStorage.getItem("fase_" + numero) || "1");
}
function avancarFase(numero){
  const f = getFaseContato(numero);
  if(f < 3) localStorage.setItem("fase_" + numero, String(f + 1));
}

function pickAleatorio(lista){
  return lista[Math.floor(Math.random() * lista.length)];
}

function gerarMensagemFallback(nome, numero){
  return wmMensagemInicial(nome, numero);
}


function gerarMensagemPorFase(nome, numero){
  const st = wmGetLeadState(numero);
  if(!st){
    return wmMensagemInicial(nome, numero);
  }
  if(wmPodeFollowup(numero)){
    return wmMensagemFollowup(nome, numero);
  }
  if(st.followEnviado){
    return `Ol√°, ${wmFormatarNome(nome)} ${wmSaudacao()}

J√° foi enviado o follow-up seguro para este lead. Aguarde resposta e siga manualmente.`;
  }
  return `Ol√°, ${wmFormatarNome(nome)} ${wmSaudacao()}

Ainda n√£o completou 48h desde o √∫ltimo envio.`;
}


function focarProximoContato(){
  setTimeout(()=>{
    const primeiro = document.querySelector(".contato-card");
    if(primeiro) primeiro.scrollIntoView({behavior:"smooth", block:"center"});
  }, 150);
}

// Atalhos: W WhatsApp, L Ligar, S Salvar, N Pr√≥ximo
document.addEventListener("keydown",(e)=>{
  const tag = document.activeElement?.tagName;
  if(tag==="INPUT"||tag==="TEXTAREA"||tag==="SELECT") return;
  const card = document.querySelector(".contato-card");
  if(!card) return;
  const k = e.key.toLowerCase();
  if(k==="w") card.querySelector(".btn-whats")?.click();
  if(k==="l") card.querySelector(".btn-ligar")?.click();
  if(k==="s") card.querySelector(".btn-salvar")?.click();
  if(k==="n"){ card.remove(); focarProximoContato(); }
});

function renderizarContatos(){
  moverSemRespostaParaHistorico();
  const lista=document.getElementById("lista-contatos");
  lista.innerHTML="";
  const filNome=document.getElementById("filtroNome").value.toLowerCase();
  const filLead=document.getElementById("filtroLead").value;
  contatos.forEach((c,idx)=>{
    if(filNome&&!c.nome.toLowerCase().includes(filNome))return;
    if(filLead&&c.lead!==filLead)return;
    const card=document.createElement("div");
    card.className="contato-card";
    const top=document.createElement("div");
    top.className="contato-top";
    top.innerHTML=`<span class="nome">${c.nome}</span><span class="numero">${c.numero}</span>`;
    const ligar=criarBtn("üìû Ligar","btn-ligar",()=>window.location.href=`tel:+55${c.numero}`);
    const whats=criarBtn("üí¨ WhatsApp","btn-whats",()=>{
      const numeroLimpo = String(c.numero).replace(/\D/g,"");
      if(!numeroLimpo){ alert("N√∫mero inv√°lido"); return; }

      // trava global (anti-banimento)
      const g = wmPodeEnviarGlobal();
      if(!g.ok){ alert("‚è≥ Aguarde "+g.restante+"s para o pr√≥ximo envio (seguran√ßa)."); return; }

      if(!podeEnviar(numeroLimpo)){
        alert("üîí Limite di√°rio atingido para este n√∫mero. Tente novamente amanh√£.");
        return;
      }

      // regra 48h: registra 1¬™ tentativa
      registrarPrimeiroContato(c.nome, numeroLimpo);

      // gera mensagem (fase 1/2/3) ou fallback
      const mensagem = gerarMensagemPorFase(c.nome, numeroLimpo);

      // registra contato no hist√≥rico para contar na meta (WhatsApp)
      const dataHora = new Date().toLocaleString();
      contatosFeitos.push({ nome:c.nome, numero:c.numero, status:"WhatsApp", info:"", lead:"", dataHora });
      localStorage.setItem("contatosFeitos", JSON.stringify(contatosFeitos));
      atualizarContatosFeitos();
      atualizarContador();

      // avan√ßa fase e registra limite di√°rio
      registrarEnvio(numeroLimpo);

      const url = `https://wa.me/55${numeroLimpo}?text=${encodeURIComponent(mensagem)}`;
      window.open(url,"_blank");

      wmRegistrarEnvioGlobal();

      // move lead para o final da fila
      const leadMov = contatos.splice(idx,1)[0];
      contatos.push(leadMov);
      wmSalvarContatos();
      renderizarContatos();
    });
    top.append(ligar,whats);card.appendChild(top);
    const form=document.createElement("div");form.className="formulario";
    const status=select(["Atendeu","Caixa","N√£o Atendeu","Desligou","Sem Resposta"]);
    const info=document.createElement("textarea");info.placeholder="Informa√ß√µes adicionais";
    const lead=select(["Quente","Frio","Aguardando"]);
    const salvar=criarBtn("üíæ Salvar","btn-salvar",()=>{
      if(!confirm("Salvar no hist√≥rico?"))return;
      marcarRespondido(String(c.numero).replace(/\D/g,""));
      const dataHora=new Date().toLocaleString();
      contatosFeitos.push({nome:c.nome,numero:c.numero,status:status.value,info:info.value,lead:lead.value,dataHora});
      localStorage.setItem("contatosFeitos",JSON.stringify(contatosFeitos));
      atualizarContatosFeitos();contatos.splice(idx,1);renderizarContatos();atualizarContador();wmSalvarContatos();
    });
    form.append(status,info,lead,salvar);card.appendChild(form);lista.appendChild(card);
  });
}

function criarBtn(txt,cls,fn){const b=document.createElement("button");b.textContent=txt;b.className=cls;b.onclick=fn;return b;}
function select(opts){const s=document.createElement("select");opts.forEach(o=>{const op=document.createElement("option");op.text=o;op.value=o;s.appendChild(op);});return s;}
function atualizarContatosFeitos(){
  const tb=document.querySelector("#contatos-feitos tbody");
  tb.innerHTML="";
  contatosFeitos.forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${c.nome}</td><td>${c.numero}</td><td>${c.status}</td><td>${c.info}</td><td>${c.lead}</td><td>${c.dataHora}</td>`;
    tb.appendChild(tr);
  });
}
function exportarCSV(){
  const csv="Nome,N√∫mero,Status,Informa√ß√µes,Lead,DataHora\n"+contatosFeitos.map(c=>[c.nome,c.numero,c.status,c.info,c.lead,c.dataHora].join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);a.download="contatos_feitos.csv";a.click();URL.revokeObjectURL(a.href);
}
function atualizarContador(){
  const hoje = new Date().toLocaleDateString();
  const total = contatosFeitos.filter(c=>c.dataHora && c.dataHora.startsWith(hoje)).length;
  document.getElementById("contador").textContent = "üìä Contatos feitos hoje: " + total;

  const metaEl = document.getElementById("metaValor");
  if(metaEl) metaEl.textContent = META_DIARIA;

  const progEl = document.getElementById("metaProgresso");
  if(progEl) progEl.textContent = `${total}/${META_DIARIA}`;

  const barra = document.getElementById("progresso");
  if(barra){
    const pct = Math.min((total / META_DIARIA) * 100, 100);
    barra.style.width = pct + "%";
  }

  if(total === META_DIARIA){
    // dispara uma vez por dia
    const k = "meta_alerta_" + hojeISO();
    if(!localStorage.getItem(k)){
      alert("üéØ Parab√©ns! Meta di√°ria de 50 contatos atingida!");
      localStorage.setItem(k, "1");
    }
  }
}

function limparFiltros(){
  document.getElementById("filtroNome").value="";
  document.getElementById("filtroLead").value="";
  renderizarContatos();
}
function resetGeral(){
  if(confirm("Apagar lista e hist√≥rico?")){
    contatos=[];contatosFeitos=[];localStorage.clear();
    document.getElementById("lista-contatos").innerHTML="";
    moverSemRespostaParaHistorico();
  atualizarContatosFeitos();
  atualizarContador();
  }
}
atualizarContatosFeitos();atualizarContador();
renderizarContatos();
</script>
</body>
</html>